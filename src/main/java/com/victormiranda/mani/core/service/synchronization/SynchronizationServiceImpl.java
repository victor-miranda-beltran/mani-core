package com.victormiranda.mani.core.service.synchronization;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.victormiranda.mani.bean.AccountInfo;
import com.victormiranda.mani.bean.Credentials;
import com.victormiranda.mani.bean.SynchronizationRequest;
import com.victormiranda.mani.bean.SynchronizationResult;
import com.victormiranda.mani.core.dao.bankaccount.BankLoginDao;
import com.victormiranda.mani.core.model.BankLogin;
import com.victormiranda.mani.core.service.bankaccount.BankAccountService;
import com.victormiranda.mani.core.service.user.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestOperations;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;
import java.util.HashSet;
import java.util.Set;

@Service
public class SynchronizationServiceImpl implements SynchronizationService {

	private final ObjectMapper objectMapper;
	private final String bankScrapperURL;
	private final RestOperations restTemplate;
	private final UserService userService;
	private final BankLoginDao bankLoginDao;
	private final BankAccountService bankAccountService;

	@Autowired
	public SynchronizationServiceImpl(
			final ObjectMapper objectMapper,
			final @Value("${services.bankscrapper.url}") String bankScrapperURL,
			final UserService userService,
			final BankLoginDao bankLoginDao,
			final BankAccountService bankAccountService) {
		this.objectMapper = objectMapper;
		this.bankScrapperURL = bankScrapperURL;
		this.restTemplate = new RestTemplate();
		this.userService = userService;
		this.bankLoginDao = bankLoginDao;
		this.bankAccountService = bankAccountService;
	}

	@Override
	public SynchronizationResult sync(final Integer bankLoginId) {
		final BankLogin bankLogin = bankLoginDao.findOne(bankLoginId);

		final Credentials credentials = bankAccountService.getLoginCredentials(bankLogin);
		final Set<AccountInfo> accountInfoSet = bankAccountService.getAccountsInfo(bankLogin);

		final SynchronizationRequest synchronizationRequest =
				new SynchronizationRequest(credentials, new HashSet<>());

		final SynchronizationResult synchronizationResult =
				restTemplate.postForObject(bankScrapperURL + "/sync",synchronizationRequest, SynchronizationResult.class);

		bankAccountService.updateBankAccounts(bankLogin, synchronizationResult);

		return synchronizationResult;
	}

	private SynchronizationResult mockedSResult() {
		SynchronizationResult synchronizationResult = null;
		try {
			final String s = "{\"accounts\":[{\"id\":\"permanenttsb Current - 6956 permanenttsb Current - 6956 permanenttsb Current - 6956 permanenttsb Current - 6956 permanenttsb Current 6956\",\"uid\":\"a02d8768-2b1a-4118-96f8-323a09d62a79\",\"availableBalance\":3592.91,\"currentBalance\":3592.91,\"lastSynced\":[2016,4,28],\"transactions\":[{\"transactionUID\":\"permanenttsb Current695627/04/2016 00:00:00CT School Things Ltd t/a3554.625819111631ICTFR3592.91\",\"description\":\"CT School Things Ltd t/a\",\"date\":[2016,4,27],\"flow\":\"IN\",\"amount\":3554.62,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695626/04/2016 00:00:00POS AMAZON.UK PA 22/04 1230.070038.29\",\"description\":\"POS AMAZON.UK PA 22/04 1\",\"date\":[2016,4,26],\"flow\":\"OUT\",\"amount\":230.07,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695625/04/2016 00:00:00POS AMAZON.ES CO 21/04 1290.8300268.36\",\"description\":\"POS AMAZON.ES CO 21/04 1\",\"date\":[2016,4,25],\"flow\":\"OUT\",\"amount\":290.83,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695625/04/2016 00:00:00POS AMAZON.UK PA 21/04 2142.3000559.19\",\"description\":\"POS AMAZON.UK PA 21/04 2\",\"date\":[2016,4,25],\"flow\":\"OUT\",\"amount\":142.30,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695618/04/2016 00:00:00MobileTopUp08XXXX793910.0000701.49\",\"description\":\"MobileTopUp08XXXX7939\",\"date\":[2016,4,18],\"flow\":\"OUT\",\"amount\":10.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695618/04/2016 00:00:00INET 24 To 40082500.0000711.49\",\"description\":\"INET 24 To 4008\",\"date\":[2016,4,18],\"flow\":\"OUT\",\"amount\":2500.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695618/04/2016 00:00:00INET 24 To 79312000.00003211.49\",\"description\":\"INET 24 To 7931\",\"date\":[2016,4,18],\"flow\":\"OUT\",\"amount\":2000.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695613/04/2016 00:00:00POS FOUR STAR PI 11/04 121.50005211.49\",\"description\":\"POS FOUR STAR PI 11/04 1\",\"date\":[2016,4,11],\"flow\":\"OUT\",\"amount\":21.50,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695612/04/2016 00:00:00POS PAYPAL *SPAN 09/04 151.65005232.99\",\"description\":\"POS PAYPAL *SPAN 09/04 1\",\"date\":[2016,4,9],\"flow\":\"OUT\",\"amount\":51.65,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695611/04/2016 00:00:00SHEILA FERNANDEZ  RENT100.00005284.64\",\"description\":\"SHEILA FERNANDEZ RENT\",\"date\":[2016,4,11],\"flow\":\"OUT\",\"amount\":100.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695611/04/2016 00:00:00SHEILA FERNANDEZ  RENT1000.00005384.64\",\"description\":\"SHEILA FERNANDEZ RENT\",\"date\":[2016,4,11],\"flow\":\"OUT\",\"amount\":1000.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695611/04/2016 00:00:00INET 24 To 40085000.00006384.64\",\"description\":\"INET 24 To 4008\",\"date\":[2016,4,11],\"flow\":\"OUT\",\"amount\":5000.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695611/04/2016 00:00:00INET 24 To 81751000.000011384.64\",\"description\":\"INET 24 To 8175\",\"date\":[2016,4,11],\"flow\":\"OUT\",\"amount\":1000.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695607/04/2016 00:00:00SHEILA FERNANDEZ  RENT100.000012384.64\",\"description\":\"SHEILA FERNANDEZ RENT\",\"date\":[2016,4,7],\"flow\":\"OUT\",\"amount\":100.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695607/04/2016 00:00:00POS FOUR STAR PI 05/04 121.500012484.64\",\"description\":\"POS FOUR STAR PI 05/04 1\",\"date\":[2016,4,5],\"flow\":\"OUT\",\"amount\":21.50,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695607/04/2016 00:00:00POS WWW MAGNET I 05/04 150.000012506.14\",\"description\":\"POS WWW MAGNET I 05/04 1\",\"date\":[2016,4,5],\"flow\":\"OUT\",\"amount\":50.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00Debit Card Charge0.460012556.14\",\"description\":\"Debit Card Charge\",\"date\":[2016,4,5],\"flow\":\"OUT\",\"amount\":0.46,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00GBP/6.99/0.7898300000\",\"description\":\"GBP/6.99/0.789830\",\"date\":[2016,4,5],\"flow\":\"OUT\",\"amount\":0,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00POS NOWTV.COM/BI 02/04 18.850012556.60\",\"description\":\"POS NOWTV.COM/BI 02/04 1\",\"date\":[2016,4,2],\"flow\":\"OUT\",\"amount\":8.85,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00Debit Card Charge2.890012565.45\",\"description\":\"Debit Card Charge\",\"date\":[2016,4,5],\"flow\":\"OUT\",\"amount\":2.89,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00GBP/130.77/0.7901980000\",\"description\":\"GBP/130.77/0.790198\",\"date\":[2016,4,5],\"flow\":\"OUT\",\"amount\":0,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00POS Amazon UK Re 02/04 1165.490012568.34\",\"description\":\"POS Amazon UK Re 02/04 1\",\"date\":[2016,4,2],\"flow\":\"OUT\",\"amount\":165.49,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00POS PAYPAL *NETF 02/04 08.990012733.83\",\"description\":\"POS PAYPAL *NETF 02/04 0\",\"date\":[2016,4,2],\"flow\":\"OUT\",\"amount\":8.99,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695605/04/2016 00:00:00POS CUSTOM HOUSE 01/04 080.000012742.82\",\"description\":\"POS CUSTOM HOUSE 01/04 0\",\"date\":[2016,4,5],\"flow\":\"OUT\",\"amount\":80.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695601/04/2016 00:00:00CT SCHOOL THING LTD3554.635816534833ICTFR12822.82\",\"description\":\"CT SCHOOL THING LTD\",\"date\":[2016,4,1],\"flow\":\"IN\",\"amount\":3554.63,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current695630/03/2016 00:00:00DD LEAP AUTOLOAD - NTA30.00581578724IDSDD9268.19\",\"description\":\"DD LEAP AUTOLOAD - NTA\",\"date\":[2016,3,30],\"flow\":\"OUT\",\"amount\":30.00,\"status\":\"NORMAL\"}]},{\"id\":\"40 Day Notice - 4008 40 Day Notice - 4008 40 Day Notice - 4008 40 Day Notice - 4008\",\"uid\":\"837e8ab0-dddd-4320-8e67-e9b92ea7ed0a\",\"availableBalance\":7500.00,\"currentBalance\":7500.00,\"lastSynced\":[2016,4,28],\"transactions\":[{\"transactionUID\":\"40 Day Notice400818/04/2016 00:00:00INET 24 Fr 69562500.00007500.00\",\"description\":\"INET 24 Fr 6956\",\"date\":[2016,4,18],\"flow\":\"IN\",\"amount\":2500.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"40 Day Notice400811/04/2016 00:00:00INET 24 Fr 69565000.00005000.00\",\"description\":\"INET 24 Fr 6956\",\"date\":[2016,4,11],\"flow\":\"IN\",\"amount\":5000.00,\"status\":\"NORMAL\"}]},{\"id\":\"vsaving - 8175 vsaving - 8175 vsaving - 8175 vsaving - 8175 vsaving 8175\",\"uid\":\"b68d20ab-79e0-4273-a085-570f0a1c233b\",\"availableBalance\":1000.00,\"currentBalance\":1000.00,\"lastSynced\":[2016,4,28],\"transactions\":[{\"transactionUID\":\"vsaving817511/04/2016 00:00:00INET 24 Fr 69561000.00001000.00\",\"description\":\"INET 24 Fr 6956\",\"date\":[2016,4,11],\"flow\":\"IN\",\"amount\":1000.00,\"status\":\"NORMAL\"}]},{\"id\":\"permanenttsb Current - 7931 permanenttsb Current - 7931 permanenttsb Current - 7931 permanenttsb Current - 7931 permanenttsb Current 7931\",\"uid\":\"332edfcf-9967-4ab0-8081-b678bd6b3823\",\"availableBalance\":3694.85,\"currentBalance\":4024.85,\"lastSynced\":[2016,4,28],\"transactions\":[{\"transactionUID\":\"permanenttsb Current793128/04/2016 00:00:00POS GREYHOUND RE 26/04 017.00004024.85\",\"description\":\"POS GREYHOUND RE 26/04 0\",\"date\":[2016,4,26],\"flow\":\"OUT\",\"amount\":17.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793128/04/2016 00:00:00POS LIDL 0942 BA 26/04 127.88004041.85\",\"description\":\"POS LIDL 0942 BA 26/04 1\",\"date\":[2016,4,26],\"flow\":\"OUT\",\"amount\":27.88,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793127/04/2016 00:00:00CNC TESCO STORES 25/04 121.25004069.73\",\"description\":\"CNC TESCO STORES 25/04 1\",\"date\":[2016,4,25],\"flow\":\"OUT\",\"amount\":21.25,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00SANDRA SANCHEZ    VICTOR100.00004090.98\",\"description\":\"SANDRA SANCHEZ VICTOR\",\"date\":[2016,4,26],\"flow\":\"OUT\",\"amount\":100.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00CNC CARRYOUT CLO 24/04 013.30004190.98\",\"description\":\"CNC CARRYOUT CLO 24/04 0\",\"date\":[2016,4,24],\"flow\":\"OUT\",\"amount\":13.30,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00POS RAHENY VETIN 23/04 152.00004204.28\",\"description\":\"POS RAHENY VETIN 23/04 1\",\"date\":[2016,4,23],\"flow\":\"OUT\",\"amount\":52.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00CNC LIDL 0942 BA 23/04 120.48004256.28\",\"description\":\"CNC LIDL 0942 BA 23/04 1\",\"date\":[2016,4,23],\"flow\":\"OUT\",\"amount\":20.48,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00POS Hailo Networ 23/04 16.80004276.76\",\"description\":\"POS Hailo Networ 23/04 1\",\"date\":[2016,4,23],\"flow\":\"OUT\",\"amount\":6.80,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00POS WOODIES DIY 23/04 1569.94004283.56\",\"description\":\"POS WOODIES DIY 23/04 15\",\"date\":[2016,4,23],\"flow\":\"OUT\",\"amount\":69.94,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00POS PAYPAL *PETT 23/04 115.00004353.50\",\"description\":\"POS PAYPAL *PETT 23/04 1\",\"date\":[2016,4,23],\"flow\":\"OUT\",\"amount\":15.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00POS Hailo Networ 23/04 17.20004368.50\",\"description\":\"POS Hailo Networ 23/04 1\",\"date\":[2016,4,23],\"flow\":\"OUT\",\"amount\":7.20,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00POS CARRYOUT CLO 22/04 114.47004375.70\",\"description\":\"POS CARRYOUT CLO 22/04 1\",\"date\":[2016,4,26],\"flow\":\"OUT\",\"amount\":14.47,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793126/04/2016 00:00:00CNC DUNNES DONAG 22/04 09.50004390.17\",\"description\":\"CNC DUNNES DONAG 22/04 0\",\"date\":[2016,4,26],\"flow\":\"OUT\",\"amount\":9.50,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793125/04/2016 00:00:00POS GREYHOUND RE 21/04 117.00004399.67\",\"description\":\"POS GREYHOUND RE 21/04 1\",\"date\":[2016,4,25],\"flow\":\"OUT\",\"amount\":17.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793125/04/2016 00:00:00CNC TESCO STORES 21/04 06.05004416.67\",\"description\":\"CNC TESCO STORES 21/04 0\",\"date\":[2016,4,25],\"flow\":\"OUT\",\"amount\":6.05,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793122/04/2016 00:00:00INET 24 Fr 4162400.00004422.72\",\"description\":\"INET 24 Fr 4162\",\"date\":[2016,4,22],\"flow\":\"IN\",\"amount\":400.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793121/04/2016 00:00:00CNC TESCO STORES 19/04 013.83004022.72\",\"description\":\"CNC TESCO STORES 19/04 0\",\"date\":[2016,4,19],\"flow\":\"OUT\",\"amount\":13.83,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793120/04/2016 00:00:00POS TESCO STORES 18/04 19.44004036.55\",\"description\":\"POS TESCO STORES 18/04 1\",\"date\":[2016,4,18],\"flow\":\"OUT\",\"amount\":9.44,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793120/04/2016 00:00:00POS TV LICENSE O 15/04 1160.00004045.99\",\"description\":\"POS TV LICENSE O 15/04 1\",\"date\":[2016,4,20],\"flow\":\"OUT\",\"amount\":160.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793119/04/2016 00:00:00CNC CARRYOUT CLO 17/04 014.47004205.99\",\"description\":\"CNC CARRYOUT CLO 17/04 0\",\"date\":[2016,4,17],\"flow\":\"OUT\",\"amount\":14.47,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793119/04/2016 00:00:00CNC CARRYOUT CLO 16/04 05.50004220.46\",\"description\":\"CNC CARRYOUT CLO 16/04 0\",\"date\":[2016,4,16],\"flow\":\"OUT\",\"amount\":5.50,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793119/04/2016 00:00:00POS CENTRA 16/04 11:26 95.90004225.96\",\"description\":\"POS CENTRA 16/04 11:26 9\",\"date\":[2016,4,19],\"flow\":\"OUT\",\"amount\":5.90,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793119/04/2016 00:00:00CNC LIDL 0942 BA 16/04 128.14004231.86\",\"description\":\"CNC LIDL 0942 BA 16/04 1\",\"date\":[2016,4,16],\"flow\":\"OUT\",\"amount\":28.14,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793118/04/2016 00:00:00INET 24 Fr 69562000.00004260.00\",\"description\":\"INET 24 Fr 6956\",\"date\":[2016,4,18],\"flow\":\"IN\",\"amount\":2000.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793118/04/2016 00:00:00INET 24 Fr 4162160.00002260.00\",\"description\":\"INET 24 Fr 4162\",\"date\":[2016,4,18],\"flow\":\"IN\",\"amount\":160.00,\"status\":\"NORMAL\"},{\"transactionUID\":\"permanenttsb Current793115/04/2016 00:00:00INET 24 Fr 41622100.00002100.00\",\"description\":\"INET 24 Fr 4162\",\"date\":[2016,4,15],\"flow\":\"IN\",\"amount\":2100.00,\"status\":\"NORMAL\"}]}],\"syncDone\":true}";
			synchronizationResult = objectMapper.readValue(s, SynchronizationResult.class);
return synchronizationResult;
		} catch (IOException e) {
			e.printStackTrace();
		}
		return null;
	}
}
